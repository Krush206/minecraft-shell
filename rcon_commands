#!/bin/bash
in=rcon_in

while read -r cmds
do
  if echo "$cmds" | \
  grep -qa '^\[[0-9]*:[0-9]*:[0-9]*] \[Server thread/INFO]: <.*> !info$'
  then
    echo "/say $(uname -a)" | nc -U $in
  elif echo "$cmds" | \
  grep -qa '^\[[0-9]*:[0-9]*:[0-9]*] \[Server thread/INFO]: <.*> !date$'
  then
    echo "/say $(date)" | nc -U $in
  elif echo "$cmds" | \
  grep -qa '^\[[0-9]*:[0-9]*:[0-9]*] \[Server thread/INFO]: <.*> !script$' ||
  echo "$cmds" | \
  grep -qa '^\[[0-9]*:[0-9]*:[0-9]*] \[Server thread/INFO]: <.*> !license$' ||
  echo "$cmds" | \
  grep -qa '^\[[0-9]*:[0-9]*:[0-9]*] \[Server thread/INFO]: <.*> !source$'
  then
    echo "/say Minecraft Shell - A Unix shell script made by a Unix guru." | \
    nc -U $in
    echo "/say Minecraft Shell is released under the terms of the GNU AGPLv3 license." | \
    nc -U $in
    echo "/say You may ask an administrator for the modified source code of this program." | \
    nc -U $in
    echo "/say The original source code can be found at: https://github.com/Krush206/minecraft-shell" | \
    nc -U $in
  elif echo "$cmds" | \
  grep -qa '^\[[0-9]*:[0-9]*:[0-9]*] \[Server thread/INFO]: <.*> !guild'
  then
    player=$(echo "$cmds" | sed --posix -u 's/.*<//;s/>.*//')
    if echo "$cmds" | \
    grep -qa '^\[[0-9]*:[0-9]*:[0-9]*] \[Server thread/INFO]: <.*> !guild create [a-zA-Z0-9]\{2,10\}$'
    then
      guild=$(echo "$cmds" | sed --posix -u 's/^.*create //')
      if ! grep -qwa "^$guild" guilds
      then
        echo "$guild $player" >> guilds
        echo "/w $player Guild created successfully!" | \
        nc -U $in
      else
        echo "/w $player This guild already exists in the database!" | \
        nc -U $in
      fi
    elif echo "$cmds" | \
    grep -qa '^\[[0-9]*:[0-9]*:[0-9]*] \[Server thread/INFO]: <.*> !guild join [a-zA-Z0-9]\{2,10\}$'
    then
      guild=$(echo "$cmds" | sed --posix -u 's/^.*join //')
      if ! grep -qwa "$player" guilds
      then
        if grep -qwa "$guild" guilds
        then
          sed --posix -i "/$guild/ s/$/ $player/" guilds
          echo "/w $player Joined $guild guild successfully!" | \
          nc -U $in
        else
          echo "/w $player This guild does not exist!" | nc -U $in
        fi
      else
        echo "/w $player You must first leave your current guild to join another!" | \
        nc -U $in
      fi
    elif echo "$cmds" | \
    grep -qa '^\[[0-9]*:[0-9]*:[0-9]*] \[Server thread/INFO]: <.*> !guild disband$'
    then
      if grep -qwa "$player" guilds
      then
        if grep -qwa "^$(sed --posix -nu /$player/p guilds | awk --posix '{ print $1 }') $player" guilds
        then
          sed --posix -i "/$player/d" guilds
          echo "/w $player You disbanded the guild!" | \
          nc -U $in
        else
          echo "/w $player You are not the owner of the guild!" | \
          nc -U $in
        fi
      else
        echo "/w $player You are not currently in a guild!" | \
        nc -U $in
      fi
    elif echo "$cmds" | \
    grep -qa '^\[[0-9]*:[0-9]*:[0-9]*] \[Server thread/INFO]: <.*> !guild leave$'
    then
      if grep -qwa "$player" guilds
      then
        sed --posix -i "s/ $player//" guilds
        echo "/w $player You left the guild!" | \
        nc -U $in
      else
        echo "/w $player You are not currently in a guild!" | \
        nc -U $in
      fi
    else
      echo "/w $player Usage: !guild <create|disband|leave>" | \
      nc -U $in
    fi
  fi
done
